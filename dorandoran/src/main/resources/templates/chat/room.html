<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">

<!-- head 영역 시작 -->
<!-- 개별적으로 사용할 css, js 링크 걸기 위해 남겨둠 -->

<head>
	<th:block layout:fragment="script">
		<script th:inline="javascript">
			$(document).ready(function () {

				var roomNm = /*[[${room.roomNm}]]*/;
				var roomNo = /*[[${room.roomNo}]]*/;
				var userNo = /*[[${session.loginUser.userNo}]]*/;

				console.log(roomNm + ", " + roomNo + ", " + userNo);

				var sockJs = new SockJS("/stomp/chat");
				//1. SockJS를 내부에 들고있는 stomp를 내어줌
				var stomp = Stomp.over(sockJs);

				//2. connection이 맺어지면 실행
				stomp.connect({}, function () {
					console.log("STOMP Connection");
					$.ajax({
							url: '/chat/room',
							type: 'get',
							data: {
								roomNo: roomNo,
								userNo : userNo
							},
							success: function () {
								console.log("update!");
							},
							error: function (e) {
								console.log(e);
							}
					});

					//4. subscribe(path, callback)으로 메세지를 받을 수 있음
					stomp.subscribe("/sub/chat/room/" + roomNo, function (chat) {
						var content = JSON.parse(chat.body);

						var writer = content.sendUserNo;
						var message = content.message;
						var roomNo = content.roomNo;
						var readYn = content.readYn;
						var str = '';
						console.log(content);
						if (writer === userNo) {
							str = "<div class='sendChat'>";
							//str += "<b th:if='${"+readYn+" eq 'N'}' class='readYn'>1</b>"
							str += "<div class='alert send'>";
							str += "<b>" + message + "</b>";
							str += "</div></div>";
							$("#msgArea").append(str);
						}
						else {
							str = "<div class='receiveChat'>";
							str += "<div class='alert recevice'>";
							str += "<b>" + message + "</b>";
							str += "</div>" 
							//str += "<b th:if='${"+readYn+" eq 'N'}' class='readYn'>1</b>"
							str += "</div>";
							$("#msgArea").append(str);
						}

						
					});

					//3. send(path, header, message)로 메세지를 보낼 수 있음
					stomp.send('/pub/chat/enter', {}, JSON.stringify({roomNo: roomNo, sendUserNo: userNo}))
				});

				$("#button-send").on("click", function (e) {
					var msg = document.getElementById("msg");

					console.log(userNo + ":" + msg.value);
					stomp.send('/pub/chat/message', {}, JSON.stringify({roomNo: roomNo, message: msg.value, sendUserNo: userNo}));
					msg.value = '';
					
				});
			});
		</script>
	</th:block>

</head>
<!-- head 영역 끝 -->

<body>
	<div layout:fragment="content">
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

		<link rel="stylesheet" th:href="@{/css/chat.css}" />

		<div class="chatContainer">
			<div class="col-6">
				<div th:if="${room.slaveNo eq session.loginUser.userNo}">
					<h1></h1>
					<h1>[[${room.masterNm}]] 님과의 채팅방</h1>
				</div>
				<div th:if="${room.masterNo eq session.loginUser.userNo}">
					<h1></h1>
					<h1>[[${room.slaveNm}]] 님과의 채팅방</h1>
				</div>
			</div>
			<div class="chats">
				<div id="msgArea" class="col">
					<div th:each="chat : ${chat}">
						<div th:if="${chat.sendUserNo != session.loginUser.userNo}">
							<div class='receiveChat'>
								<div class='alert recevice'>
									<b>[[${chat.message}]]</b>
								</div>
								<!--<b th:if="${chat.readYn eq 'N'}" class="readYn">1</b>-->
							</div>
						</div>
						<div th:if="${chat.sendUserNo == session.loginUser.userNo}">
							<div class='sendChat'>
								<!--<b th:if="${chat.readYn eq 'N'}" class="readYn">1</b>-->
								<div class='alert send'>
									<b>[[${chat.message}]]</b>
								</div>
							</div>
						</div>
					</div>

				</div>
				<div class="col2">
					<div class="input-group">
						<input type="text" id="msg" class="form-control">
						<div class="input-group-append">
							<button class="sendBtn" type="button" id="button-send">전송</button>
						</div>
					</div>
				</div>
			</div>
			<div class="col-6"></div>
		</div>

	</div>
</body>

</html>